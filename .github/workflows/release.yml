name: release

on:
  push:
    tags:
      - 'v*.*'

jobs:
  e2e:
    # Ensure E2E runs serialize with other E2E workflows
    concurrency:
      group: konnect-e2e
      cancel-in-progress: false
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(vars.GHA_DEFAULT_TIMEOUT) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Build
        run: make build
      - name: Run E2E tests (Konnect)
        env:
          KONGCTL_E2E_KONNECT_PAT: ${{ secrets.KONGCTL_E2E_KONNECT_PAT }}
          KONGCTL_E2E_KONNECT_BASE_URL: ${{ secrets.KONGCTL_E2E_KONNECT_BASE_URL }}
          KONGCTL_E2E_RESET: "1"
          KONGCTL_E2E_LOG_LEVEL: "info"
          KONGCTL_E2E_ARTIFACTS_DIR: ${{ runner.temp }}/kongctl-e2e-${{ github.run_id }}
        run: |
          make test-e2e
      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-${{ github.run_id }}
          path: ${{ runner.temp }}/kongctl-e2e-${{ github.run_id }}

  goreleaser:
    needs: e2e
    timeout-minutes: ${{ fromJSON(vars.GHA_DEFAULT_TIMEOUT) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - run: git config --global url.https://$GITHUB_TOKEN@github.com/.insteadOf https://github.com/
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PRIVATE_READ }}
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2' 
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
      - name: Upload assets
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*
