name: sdk-konnect-go pre-release

on:
  #schedule:
  #  - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'sdk-konnect-go prerelease tag (default: latest prerelease)'
        required: false
      force:
        description: 'Run even if an existing PR is open'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  stage:
    name: Stage prerelease
    runs-on: ubuntu-latest
    steps:
      - name: Resolve latest prerelease
        id: release
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const sdkOwner = 'Kong';
            const sdkRepo = 'sdk-konnect-go';

            const tagInput = (context.payload.inputs?.tag || '').trim();
            const forceInput = (context.payload.inputs?.force || '').toLowerCase() === 'true';
            const eventName = context.eventName;

            let release;
            let tag = tagInput;

            if (tag) {
              try {
                const { data } = await github.rest.repos.getReleaseByTag({
                  owner: sdkOwner,
                  repo: sdkRepo,
                  tag,
                });
                release = data;
                if (!release.prerelease) {
                  core.warning(`Release ${tag} is not marked as a prerelease.`);
                }
              } catch (error) {
                core.setFailed(`Failed to find release ${tag}: ${error.message}`);
                return;
              }
            } else {
              const releases = await github.paginate(github.rest.repos.listReleases, {
                owner: sdkOwner,
                repo: sdkRepo,
                per_page: 20,
              });
              release = releases.find((item) => item.prerelease);
              if (!release) {
                const message = 'No prerelease releases found for Kong/sdk-konnect-go';
                if (eventName === 'workflow_dispatch') {
                  core.setFailed(message);
                } else {
                  core.info(message);
                }
                core.setOutput('found', 'false');
                core.setOutput('force', forceInput ? 'true' : 'false');
                return;
              }
              tag = release.tag_name;
            }

            core.setOutput('found', 'true');
            core.setOutput('tag', tag);
            core.setOutput('name', release.name || tag);
            core.setOutput('release_url', release.html_url || '');
            core.setOutput('published_at', release.published_at || release.created_at || '');
            core.setOutput('force', forceInput ? 'true' : 'false');

            const headRef = `${context.repo.owner}:sdk-konnect-go/${tag}`;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: headRef,
              per_page: 1,
            });

            if (prs.length > 0) {
              core.info(`Existing PR detected: #${prs[0].number}`);
              core.setOutput('pr_exists', 'true');
              core.setOutput('pr_number', String(prs[0].number));
              core.setOutput('pr_url', prs[0].html_url);
            } else {
              core.setOutput('pr_exists', 'false');
            }

            return tag;

      - name: Decide execution plan
        id: decision
        env:
          FOUND: ${{ steps.release.outputs.found }}
          PR_EXISTS: ${{ steps.release.outputs.pr_exists }}
          FORCE: ${{ steps.release.outputs.force }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "${FOUND}" != "true" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${PR_EXISTS}" = "true" ] && [ "${EVENT_NAME}" = "schedule" ] && [ "${FORCE}" != "true" ]; then
            echo "Existing PR detected; skipping scheduled run."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        if: steps.decision.outputs.run == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Go
        if: steps.decision.outputs.run == 'true'
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Bump sdk-konnect-go dependency
        if: steps.decision.outputs.run == 'true'
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          set -euo pipefail
          go get github.com/Kong/sdk-konnect-go@"${TAG}"
          go mod tidy

      - name: Check for dependency changes
        if: steps.decision.outputs.run == 'true'
        id: diff
        run: |
          if git diff --quiet -- go.mod go.sum; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            git diff --stat -- go.mod go.sum
          fi

      - name: Prepare PR body
        if: steps.diff.outputs.changed == 'true'
        id: summary
        env:
          TAG: ${{ steps.release.outputs.tag }}
          RELEASE_NAME: ${{ steps.release.outputs.name }}
          RELEASE_URL: ${{ steps.release.outputs.release_url }}
          PUBLISHED_AT: ${{ steps.release.outputs.published_at }}
        run: |
          PR_BODY_PATH="${RUNNER_TEMP}/pr-body.md"

          {
            echo "## Pre-release: sdk-konnect-go ${TAG}"
            if [ -n "${RELEASE_URL}" ]; then
              echo "- Release: [${RELEASE_NAME}](${RELEASE_URL})"
            else
              echo "- Release: ${RELEASE_NAME}"
            fi
            if [ -n "${PUBLISHED_AT}" ]; then
              echo "- Published: ${PUBLISHED_AT}"
            fi
            echo ""
            echo "### Notes"
            echo "- Dependency bump staged for automated validation."
            echo "- Standard PR workflows (lint/unit/e2e) will run on this branch."
          } > "${PR_BODY_PATH}"

          echo "body_path=${PR_BODY_PATH}" >> "$GITHUB_OUTPUT"

      - name: Create or update PR
        if: steps.diff.outputs.changed == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          branch: sdk-konnect-go/${{ steps.release.outputs.tag }}
          commit-message: 'pre-release: sdk-konnect-go ${{ steps.release.outputs.tag }}'
          title: 'pre-release: sdk-konnect-go: ${{ steps.release.outputs.tag }}'
          body-path: ${{ steps.summary.outputs.body_path }}
          delete-branch: false
          token: ${{ secrets.PAT }}

      - name: Apply default prerelease label
        if: steps.diff.outputs.changed == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER || '0', 10);
            if (!prNumber) {
              core.info('No pull request number found; skipping label management.');
              return;
            }

            const prereleaseLabels = ['alpha', 'beta', 'rc'];
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const hasPrerelease = pr.labels.some((label) =>
              prereleaseLabels.includes(label.name)
            );

            if (hasPrerelease) {
              core.info('Prerelease label already present on PR.');
              return;
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['alpha'],
            });

            core.info('Applied default prerelease label: alpha.');
