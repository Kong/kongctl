# `kongctl` Declarative Config UX

Here we describe the user experience of using `kongctl` to manage declarative configuration 
in Kong (and specifically Kong Konnect).

## Overview

`kongctl`'s declarative configuration feature will center around the concept of a _plan_. A plan is an artifact that
contains instructions to move a set of resources from their current state to a desired state.
Plans are generated by calculating the difference between the current state of resources and the desired state 
which is represented by a folder hierarchy of declarative configuration files.

Plans are generated by logic within `kongctl` and are then used as the basis for other declarative configuration 
functions provided by `kongctl`.

Plans can be saved, transported, reviewed, and later applied. The system will always need to account for resource
configuration drift when applying plans. 

`kongctl` commands may use plans internally even if they are not stored, moved, or used in subsequent commands. 

We distinguish two important use cases in declarative configuration workflows:
* `sync`
  * A user wants to fully manage all resources in a set of configurations including destruction of resources that don't exist in desired configuration
  * Resource filters will be used to limit the scope of resources that are managed
  * Existing resources are fully updated to match the configuration including the reversion of unspecified values to their defaults or removal
  * This would be commonly utilized in a full CI/CD based workflow where a user wants full automated management of all resources in a configuration set
  * We provide important features to help users mitigate against accidental destruction of resources or other unintentional changes
* `apply`
  * A user wants to create or update a set of resources based on an input configuration, but resource destruction is not considered
  * Only specified resource values are updated, unspecified values are not considered
  * This allows resources to be "built up" using a series of `apply` commands and the full configuration is not required 
  * This has proven useful in many workflows including onboarding, quickstarts, documentation guides, and more
  * This is generally considered a "one-shot" operation (not continuous like CI/CD) and users may need guidance or help to remove the 
    resources later (potentially with an imperative command we provide)

Both of these use a `plan` prior to executing any changes to resources.

A user can also create a plan without executing any resource changes. This is useful for reviewing, storing, transporting, and vetting plans
prior to executing the changes contained within them.

## Notes

* Remember in Konnect organizations are keyed off the access token used in API requests. `kongctl` provides capabilities to provide 
access tokens via flags, env vars, or configuration files. The tool also supports `kongctl login` supporting the device auth grant flow
to allow a user to login via a web browser and authorize CLI.
* `kongctl` is designed to support non-Konnect use cases, but will follow a "Konnect first" approach. The existing command design follows a 
`kongctl <verb> <product> <resource> <sub-resource>` pattern. "Konnect first means the `konnect` product will be implied if no product is specified.
So, for example, `kongctl sync` is a shortcut for `kongctl sync konnect` but we will look to support `kongctl sync gateway` or similar in the future.

## Example Commands

### plan

The `plan` command is used to generate plan files. This is useful for viewing, storing, and transporting plans prior to applying them.

```bash
# Generate a plan from the current folder and output it to STDOUT
kongctl plan
```

```bash
# Generate a plan from a specific folder and output it to STDOUT
kongctl plan --dir /path/to/configs
```

```bash
# Generate a plan from a specific folder and save it to a file
kongctl plan --dir /path/to/configs --output-file my-plan.json
```

```bash
# By default, the plan will include full resource management, including deletes and all value updates.
# The `--apply-only` flag essentially generates a `plan` for an `apply` operation
kongctl plan --apply-only
```

### dump

The `dump` command is used to export existing resources into declarative configuration files. This is useful for
migrating existing resources into declarative configuration, or for generating a backup of existing resources.

```bash
# Outputs all resources available into declarative configuration files in the current directory (file layout tbd)
kongctl dump 
```

```bash
# We need to support dumping a subset of resources, likely by a variety of filtering possibilities
kongctl dump --filter <tbd>
```

#### Notes
* Consider how resource ownership metadata is handled when resources are dumped and subsequently applied.

### apply

The `apply` command is used to create and update a set of resources from an input configuration. 
Existing resources or values that are not present in the input configuration are not considered. 

```bash
# Apply a newly generated plan (with --apply-only) 
kongctl apply
```

```bash
# If the plan was generated without `--apply-only` it is entirely rejected by the `apply` command. 
kongctl apply --plan my-plan.json
```

### sync

The `sync` command is used to fully manage a set of resources from an input configuration.

```bash
# Syncs a newly generated plan from the current directory
kongctl sync 
```

```bash
# Syncs a given plan file
kongctl sync --plan my-plan.json
```

### diff

`diff` prints a human friendly report of the difference between a plan and the current state of resources. 
If a `plan` file is not provided it will generate a plan from input configuration. 

```bash
# Calculates a plan from configuration in the current directory and displays a human 
# friendly report of the difference
kongctl diff
```

```bash
# Calculates an apply only plan from the configuration in the current directory and 
# displays a human friendly report of the difference
kongctl diff --apply-only
```

```bash
# Prints a human friendly report of the differences contained in a plan file
kongctl diff --plan my-plan.json
```

```bash
# Calculates a plan from the input configuration and prints a human friendly report of the difference
kongctl diff --dir /path/to/configs
```

```bash
# Calculates a plan from the input configuration and writes a report of the difference in YAML format
kongctl diff --dir /path/to/configs --output yaml
```
