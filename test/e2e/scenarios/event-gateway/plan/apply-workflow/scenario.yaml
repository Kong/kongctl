baseInputsPath: ../../../../testdata/declarative/event-gateways/plan/apply

env:
  KONGCTL_LOG_LEVEL: info

vars:
  egwRef: plan-apply-egw
  egwName: plan-apply-egw
  egwInitialDesc: "Initial description for plan apply workflow"
  egwUpdatedDesc: "Updated description for plan apply workflow"
  bcRef: plan-apply-backend-cluster
  bcName: plan-apply-backend-cluster
  bcDesc: "Updated description for plan apply backend cluster"
  vcRef: plan-apply-virtual-cluster
  vcName: plan-apply-virtual-cluster
  vcDesc: "Virtual cluster for plan apply workflow"

defaults:
  mask:
    dropKeys:
      - id
      - created_at
      - updated_at

steps:
  - name: 000-reset-org
    skipInputs: true
    commands:
      - resetOrg: true

  - name: 001-plan-apply-create
    commands:
      - name: 000-plan-create
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-create.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.CREATE: 1
      - name: 001-diff-plan-text
        outputFormat: text
        parseAs: raw
        run:
          - diff
          - --plan
          - "{{ .workdir }}/plan-create.json"
        assertions:
          - select: stdout
            expect:
              fields:
                "contains(@, 'Plan: 1 to add')": true
                "contains(@, 'event_gateway \"plan-apply-egw\" will be created')": true
      - name: 002-apply-plan
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-create.json"
          - --auto-approve
        assertions:
          - select: plan.metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
      - name: 003-get-event-gateways
        run: ["get", "event-gateways", "-o", "json"]
        assertions:
          - select: "[?name=='{{ .vars.egwRef }}'] | [0]"
            expect:
              fields:
                name: "{{ .vars.egwName }}"
                description: "{{ .vars.egwInitialDesc }}"
  - name: 002-plan-apply-update
    inputOverlayDirs:
      - overlays/001-update
    commands:
      - name: 000-plan-update
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-update.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.UPDATE: 1
      - name: 001-diff-plan-text
        outputFormat: text
        parseAs: raw
        run:
          - diff
          - --plan
          - "{{ .workdir }}/plan-update.json"
        assertions:
          - select: stdout
            expect:
              fields:
                "contains(@, 'event_gateway \"plan-apply-egw\" will be updated')": true
      - name: 002-apply-plan
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-update.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
          - select: plan.summary
            expect:
              fields:
                by_action.UPDATE: 1
      - name: 003-get-event-gateways
        run: ["get", "event-gateways", "-o", "json"]
        assertions:
          - select: "[?name=='{{ .vars.egwRef }}'] | [0]"
            expect:
              fields:
                name: "{{ .vars.egwName }}"
                description: "{{ .vars.egwUpdatedDesc }}"

  - name: 003-plan-apply-backend-cluster
    inputOverlayDirs:
      - overlays/002-backend-cluster
    commands:
      - name: 000-plan-create-backend-cluster
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-backend-cluster.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.CREATE: 1
          - select: >-
              changes[?resource_type=='event_gateway_backend_cluster' && resource_ref=='{{ .vars.bcRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.bcRef }}"
      - name: 001-diff-plan-text
        outputFormat: text
        parseAs: raw
        run:
          - diff
          - --plan
          - "{{ .workdir }}/plan-backend-cluster.json"
        assertions:
          - select: stdout
            expect:
              fields:
                "contains(@, 'Plan: 1 to add')": true
                "contains(@, 'event_gateway_backend_cluster \"plan-apply-backend-cluster\" will be created')": true
      - name: 002-apply-plan
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-backend-cluster.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
      - name: 003-verify-backend-cluster
        run:
          - get
          - event-gateway
          - backend-clusters
          - --gateway-name
          - "{{ .vars.egwName }}"
          - -o
          - json
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[0]"
            expect:
              fields:
                name: "{{ .vars.bcName }}"
                description: "{{ .vars.bcDesc }}"
                bootstrap_servers:
                  - "egw-backend-1-updated.example.com:9092"
                authentication.type: "anonymous"

  - name: 004-plan-apply-virtual-cluster
    inputOverlayDirs:
      - overlays/003-virtual-cluster
    commands:
      - name: 000-plan-create-virtual-cluster
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-virtual-cluster.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.CREATE: 1
          - select: >-
              changes[?resource_type=='event_gateway_virtual_cluster' && resource_ref=='{{ .vars.vcRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.vcRef }}"
      - name: 001-diff-plan-text
        outputFormat: text
        parseAs: raw
        run:
          - diff
          - --plan
          - "{{ .workdir }}/plan-virtual-cluster.json"
        assertions:
          - select: stdout
            expect:
              fields:
                "contains(@, 'Plan: 1 to add')": true
                "contains(@, 'event_gateway_virtual_cluster \"plan-apply-virtual-cluster\" will be created')": true
      - name: 002-apply-plan
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-virtual-cluster.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
      - name: 003-verify-virtual-cluster
        run:
          - get
          - event-gateway
          - virtual-clusters
          - --gateway-name
          - "{{ .vars.egwName }}"
          - -o
          - json
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[0]"
            expect:
              fields:
                name: "{{ .vars.vcName }}"
                description: "{{ .vars.vcDesc }}"
                destination.name: "{{ .vars.bcName }}"
                acl_mode: "passthrough"
                "length(authentication)": 1
                authentication[0].type: "sasl_scram"

  - name: 005-plan-apply-listener
    inputOverlayDirs:
      - overlays/004-listener
    commands:
      - name: 000-plan-create-listener
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-listener.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.CREATE: 1
          - select: >-
              changes[?resource_type=='event_gateway_listener' && resource_ref=='plan-apply-listener'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "plan-apply-listener"
      - name: 001-diff-plan-text
        outputFormat: text
        parseAs: raw
        run:
          - diff
          - --plan
          - "{{ .workdir }}/plan-listener.json"
        assertions:
          - select: stdout
            expect:
              fields:
                "contains(@, 'Plan: 1 to add')": true
                "contains(@, 'event_gateway_listener \"plan-apply-listener\" will be created')": true
      - name: 002-apply-plan
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-listener.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
      - name: 003-verify-listener
        run:
          - get
          - event-gateway
          - listeners
          - --gateway-name
          - "{{ .vars.egwName }}"
          - -o
          - json
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[0]"
            expect:
              fields:
                name: "plan-apply-listener"
                description: "Listener for plan apply workflow"
                ports:
                  - "9093-9095"
                addresses:
                  - localhost
