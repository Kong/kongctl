baseInputsPath: ../../../testdata/declarative/portal/applications

log-level: debug

vars:
  portalRef: auto-approve-portal
  portalName: "Auto Approve Portal"
  developerEmail: ""
  developerName: "Portal Applications User"
  developerPassword: "P@ssword123!"
  applicationName: "e2e-portal-application"
  apiName: "Auto Applied API"

defaults:
  mask:
    dropKeys:
      - id
      - change_id
      - resource_id
      - generated_at
      - created_at
      - updated_at

steps:
  - name: 000-init
    skipInputs: true
    commands:
      - name: 000-generate-developer-email
        parseAs: raw
        exec:
          - bash
          - -c
          - |
            set -euo pipefail
            base="${KONGCTL_E2E_GMAIL_ADDRESS:-}"
            if [ -z "$base" ]; then
              echo "KONGCTL_E2E_GMAIL_ADDRESS not set" >&2
              exit 1
            fi
            localpart="${base%@*}"
            domain="${base##*@}"
            if [ -z "$localpart" ] || [ -z "$domain" ]; then
              echo "invalid KONGCTL_E2E_GMAIL_ADDRESS: ${base}" >&2
              exit 1
            fi
            localpart="${localpart%%+*}"
            printf '%s+portal-applications-%s@%s' "$localpart" "$(date +%s%N)" "$domain"
        recordVar:
          name: developerEmail
          responsePath: "stdout"

  - name: 001-reset-org
    skipInputs: true
    commands:
      - resetOrg: true

  - name: 002-configure-portal
    commands:
      - name: 000-plan-create
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-initial.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 8
                by_action.CREATE: 8
          - select: >-
              changes[?resource_type=='portal' && resource_ref=='{{ .vars.portalRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.portalRef }}"
                fields.auto_approve_developers: true
                fields.auto_approve_applications: true

      - name: 001-apply-create
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-initial.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 8
                failed: 0

      - name: 002-verify-portal
        outputFormat: json
        run:
          - get
          - portal
          - "{{ .vars.portalName }}"
        assertions:
          - select: "@"
            expect:
              fields:
                name: "{{ .vars.portalName }}"
        recordVar:
          name: portalBaseDomain
          responsePath: "canonical_domain"

      - name: 003-record-portal-id
        outputFormat: json
        run:
          - get
          - portal
          - "{{ .vars.portalName }}"
        recordVar:
          name: portalID
          responsePath: "id"

      - name: 004-record-team-ids
        outputFormat: json
        run:
          - get
          - portal
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
        recordVar:
          name: teamAlphaID
          responsePath: "[?name=='Portal App Team Alpha'] | [0].id"

  - name: 003-register-developer-and-application
    skipInputs: true
    commands:
      - name: 000-register-and-create
        workdir: "{{ .repo_dir }}"
        exec:
          - go
          - run
          - ./test/e2e/harness/portalclient/cmd/devworkflow
          - --base-url
          - "https://{{ .vars.portalBaseDomain }}"
          - --portal-id
          - "{{ .vars.portalID }}"
          - --developer-email
          - "{{ .vars.developerEmail }}"
          - --developer-name
          - "{{ .vars.developerName }}"
          - --developer-password
          - "{{ .vars.developerPassword }}"
          - --application-name
          - "{{ .vars.applicationName }}"
          - --registration-api-name
          - "{{ .vars.apiName }}"

  - name: 004-assign-developer-team
    skipInputs: true
    commands:
      - name: 000-get-developer-id
        outputFormat: json
        run:
          - get
          - portal
          - developers
          - --portal-name
          - "{{ .vars.portalName }}"
          - "{{ .vars.developerEmail }}"
        recordVar:
          name: developerID
          responsePath: "id"

      - name: 001-add-developer-to-team
        create:
          resource: portal-team-developer
          payload:
            inline:
              id: "{{ .vars.developerID }}"
          expectStatus: 201
          endpointParams:
            portalId: "{{ .vars.portalID }}"
            teamId: "{{ .vars.teamAlphaID }}"

      - name: 002-verify-developer-team-membership
        outputFormat: json
        run:
          - get
          - portal
          - developers
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
          - --team-id
          - "{{ .vars.teamAlphaID }}"
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[0]"
            expect:
              fields:
                email: "{{ .vars.developerEmail }}"

  - name: 005-verify-portal-applications
    skipInputs: true
    commands:
      - name: 000-get-applications
        outputFormat: json
        run:
          - get
          - portal
          - applications
          - --portal-name
          - "{{ .vars.portalName }}"
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[?name=='{{ .vars.applicationName }}'] | [0]"
            expect:
              fields:
                name: "{{ .vars.applicationName }}"

  - name: 006-verify-team-roles-empty
    skipInputs: true
    commands:
      - name: 000-get-team-roles
        outputFormat: json
        run:
          - get
          - portal
          - team
          - roles
          - --portal-name
          - "{{ .vars.portalName }}"
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 0

  - name: 007-verify-application-registrations
    skipInputs: true
    commands:
      - name: 000-get-registrations
        outputFormat: json
        run:
          - get
          - portal
          - application-registrations
          - --portal-name
          - "{{ .vars.portalName }}"
          - --application-name
          - "{{ .vars.applicationName }}"
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 1
          - select: "[0]"
            expect:
              fields:
                status: approved
                api.name: "{{ .vars.apiName }}"
                application.name: "{{ .vars.applicationName }}"
        recordVar:
          name: registrationID
          responsePath: "[0].id"

  - name: 008-delete-application-registration
    skipInputs: true
    commands:
      - name: 000-delete-registration
        outputFormat: json
        run:
          - delete
          - portal
          - application-registrations
          - --approve
          - --portal-name
          - "{{ .vars.portalName }}"
          - "{{ .vars.registrationID }}"

  - name: 009-delete-portal-application
    skipInputs: true
    commands:
      - name: 000-delete-application
        outputFormat: json
        run:
          - delete
          - portal
          - applications
          - --approve
          - --force
          - --portal-name
          - "{{ .vars.portalName }}"
          - "{{ .vars.applicationName }}"
        assertions:
          - select: "@"
            expect:
              fields:
                status: deleted
                portal_id: "{{ .vars.portalID }}"

  - name: 010-verify-post-delete
    skipInputs: true
    commands:
      - name: 000-get-applications-after-delete
        outputFormat: json
        run:
          - get
          - portal
          - applications
          - --portal-name
          - "{{ .vars.portalName }}"
        assertions:
          - select: "length(@)"
            expect:
              fields:
                "@": 0
