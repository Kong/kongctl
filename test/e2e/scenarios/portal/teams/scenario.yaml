baseInputsPath: ../../../testdata/declarative/portal/teams

log-level: debug

vars:
  namespace: portal-teams-test
  portalRef: dev-portal
  portalName: "Developer Portal"
  backendTeamRef: backend-team
  frontendTeamRef: frontend-team
  mobileTeamRef: mobile-team
  qaTeamRef: qa-team
  rolesAPIRef: roles-api
  backendViewerRoleRef: backend-api-viewer
  frontendConsumerRoleRef: frontend-api-consumer
  qaViewerRoleRef: qa-api-viewer

defaults:
  mask:
    dropKeys:
      - id
      - change_id
      - resource_id
      - generated_at
      - created_at
      - updated_at

steps:
  - name: 000-reset-org
    skipInputs: true
    commands:
      - resetOrg: true

  - name: 001-create-portal-with-teams
    commands:
      - name: 000-plan-initial-create
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-initial.json"
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: metadata
            expect:
              fields:
                mode: apply
          - select: summary
            expect:
              fields:
                total_changes: 4
                by_action.CREATE: 4
          # Verify portal creation
          - select: >-
              changes[?resource_type=='portal' && resource_ref=='{{ .vars.portalRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.portalRef }}"
          # Verify backend team creation
          - select: >-
              changes[?resource_type=='portal_team' && resource_ref=='{{ .vars.backendTeamRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.backendTeamRef }}"
                fields.name: "Backend Team"
                fields.description: "Backend developers working on APIs"
          # Verify frontend team creation
          - select: >-
              changes[?resource_type=='portal_team' && resource_ref=='{{ .vars.frontendTeamRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.frontendTeamRef }}"
                fields.name: "Frontend Team"
          # Verify mobile team creation
          - select: >-
              changes[?resource_type=='portal_team' && resource_ref=='{{ .vars.mobileTeamRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.mobileTeamRef }}"
                fields.name: "Mobile Team"

      - name: 001-apply-initial-create
        outputFormat: json
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-initial.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 4
                failed: 0

      - name: 002-verify-teams-created
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - get
          - portal
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
          - -o
          - json
        assertions:
          # Verify we have 3 teams
          - select: "length(@)"
            expect:
              fields:
                "@": 3
          # Verify backend team
          - select: "[?name=='Backend Team'] | [0]"
            expect:
              fields:
                name: "Backend Team"
                description: "Backend developers working on APIs"
          # Verify frontend team
          - select: "[?name=='Frontend Team'] | [0]"
            expect:
              fields:
                name: "Frontend Team"
                description: "Frontend developers building UIs"
          # Verify mobile team
          - select: "[?name=='Mobile Team'] | [0]"
            expect:
              fields:
                name: "Mobile Team"
                description: "Mobile app developers"

  - name: 002-update-team-description
    inputOverlayDirs:
      - overlays/002-update-team
    commands:
      - name: 000-plan-update
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-update.json"
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.UPDATE: 1
          # Verify only backend team is updated
          - select: >-
              changes[?resource_type=='portal_team' && resource_ref=='{{ .vars.backendTeamRef }}'] | [0]
            expect:
              fields:
                action: UPDATE
                resource_ref: "{{ .vars.backendTeamRef }}"
                fields.description: "Updated: Backend API developers"

      - name: 001-apply-update
        outputFormat: json
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-update.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0

      - name: 002-verify-team-updated
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - get
          - portal
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
          - -o
          - json
        assertions:
          # Verify backend team has updated description
          - select: "[?name=='Backend Team'] | [0]"
            expect:
              fields:
                name: "Backend Team"
                description: "Updated: Backend API developers"
          # Verify other teams unchanged
          - select: "[?name=='Frontend Team'] | [0]"
            expect:
              fields:
                description: "Frontend developers building UIs"

  - name: 003-sync-delete-team
    inputOverlayDirs:
      - overlays/003-sync-delete
    commands:
      - name: 000-plan-sync-delete
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-sync-delete.json"
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - sync
        assertions:
          - select: metadata
            expect:
              fields:
                mode: sync
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.DELETE: 1
          # Verify mobile team is deleted
          - select: >-
              changes[?resource_type=='portal_team' && action=='DELETE'] | [0]
            expect:
              fields:
                action: DELETE
                fields.name: "Mobile Team"

      - name: 001-apply-sync-delete
        outputFormat: json
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - sync
          - --plan
          - "{{ .workdir }}/plan-sync-delete.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0

      - name: 002-verify-team-deleted
        run:
          - get
          - portal
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
          - -o
          - json
        assertions:
          # Verify we now have 2 teams
          - select: "length(@)"
            expect:
              fields:
                "@": 2
          # Verify mobile team is gone
          - select: "[?name=='Mobile Team']"
            expect:
              fields:
                "length(@)": 0

  - name: 004-root-level-team-declaration
    inputOverlayDirs:
      - overlays/004-root-level
    commands:
      - name: 000-plan-root-level
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-root-level.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.CREATE: 1
          # Verify QA team creation at root level
          - select: >-
              changes[?resource_type=='portal_team' && resource_ref=='{{ .vars.qaTeamRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.qaTeamRef }}"
                fields.name: "QA Team"
                fields.description: "Quality Assurance team"

      - name: 001-apply-root-level
        outputFormat: json
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-root-level.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0

      - name: 002-verify-root-level-team
        run:
          - get
          - portal
          - teams
          - --portal-name
          - "{{ .vars.portalName }}"
          - -o
          - json
        assertions:
          # Verify we now have 3 teams (backend, frontend, qa)
          - select: "length(@)"
            expect:
              fields:
                "@": 3
          # Verify QA team exists
          - select: "[?name=='QA Team'] | [0]"
            expect:
              fields:
                name: "QA Team"
                description: "Quality Assurance team"

  - name: 005-team-role-assignments
    inputOverlayDirs:
      - overlays/005-team-roles
    commands:
      - name: 000-plan-team-roles
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-team-roles.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: summary
            expect:
              fields:
                total_changes: 4
                by_action.CREATE: 4
          - select: >-
              changes[?resource_type=='api' && resource_ref=='{{ .vars.rolesAPIRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                resource_ref: "{{ .vars.rolesAPIRef }}"
          - select: >-
              changes[?resource_type=='portal_team_role' && resource_ref=='{{ .vars.backendViewerRoleRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                fields.role_name: "API Viewer"
          - select: >-
              changes[?resource_type=='portal_team_role' && resource_ref=='{{ .vars.frontendConsumerRoleRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                fields.role_name: "API Consumer"
          - select: >-
              changes[?resource_type=='portal_team_role' && resource_ref=='{{ .vars.qaViewerRoleRef }}'] | [0]
            expect:
              fields:
                action: CREATE
                fields.role_name: "API Viewer"

      - name: 001-apply-team-roles
        outputFormat: json
        env:
          KONNECT_SDK_HTTP_DUMP_REQUEST: "true"
          KONNECT_SDK_HTTP_DUMP_RESPONSE: "true"
        run:
          - apply
          - --plan
          - "{{ .workdir }}/plan-team-roles.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 4
                failed: 0

      - name: 002-plan-team-roles-idempotent
        outputFormat: disable
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: summary
            expect:
              fields:
                total_changes: 0

  - name: 006-team-role-removal-sync
    inputOverlayDirs:
      - overlays/006-remove-team-role
    commands:
      - name: 000-plan-team-role-removal
        outputFormat: disable
        stdoutFile: "{{ .workdir }}/plan-team-role-removal.json"
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - sync
        assertions:
          - select: metadata
            expect:
              fields:
                mode: sync
          - select: summary
            expect:
              fields:
                total_changes: 1
                by_action.DELETE: 1
          - select: >-
              changes[?resource_type=='portal_team_role' && action=='DELETE'] | [0]
            expect:
              fields:
                resource_type: portal_team_role

      - name: 001-apply-team-role-removal
        outputFormat: json
        run:
          - sync
          - --plan
          - "{{ .workdir }}/plan-team-role-removal.json"
          - --auto-approve
        assertions:
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0

      - name: 002-plan-post-removal
        outputFormat: disable
        run:
          - plan
          - -f
          - "{{ .workdir }}/config.yaml"
          - --mode
          - apply
        assertions:
          - select: summary
            expect:
              fields:
                total_changes: 0
