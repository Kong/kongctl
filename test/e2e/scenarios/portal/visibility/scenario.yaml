baseInputsPath: ../../../testdata/declarative/portal/full

env:
  KONGCTL_LOG_LEVEL: info

vars:
  portalName: "My First Portal"
  smsAPIName: "SMS API"

defaults:
  mask:
    dropKeys: 
      - id
      - created_at
      - resource_id 
      - change_id
      - updated_at

steps:
  - name: 000-reset-org
    skipInputs: true
    commands:
      - resetOrg: true

  - name: 001-initial-apply
    commands:
      - name: 000-apply
        run:
          - apply
          - -f
          - "{{ .workdir }}/portal.yaml"
          - -f
          - "{{ .workdir }}/apis.yaml"
          - --auto-approve
        assertions:
          - select: "plan.changes[?resource_type=='portal' && resource_ref=='getting-started-portal'] | [0]"
            expect:
              file: "expect/initial-apply/portal-create-change.json"
          - select: "execution.applied_changes[?resource_type=='portal' && resource_ref=='getting-started-portal'] | [0]"
            expect:
              file: "expect/initial-apply/portal-create-applied-change.json"

      - name: 001-get-portals
        run: ["get", "portals"]
        assertions:
          - select: "[?name=='{{ .vars.portalName }}'] | [0]"
            expect:
              file: "expect/initial-apply/get-portals.json"
            mask:
              dropKeys:
                - canonical_domain
                - default_domain

      - name: 002-get-apis
        run: ["get", "apis"]
        assertions:
          - select: "[?name=='{{ .vars.smsAPIName }}'] | [0]"
            expect:
              file: "expect/initial-apply/get-apis.json"
            mask:
              dropKeys:
                - api_spec_ids

  - name: 002-mutate-publication-visibility
    inputOverlayOps:
      - file: "apis.yaml"
        match: "apis[?ref=='sms'].publications[?ref=='sms-api-to-getting-started'] | [0]"
        set:
          visibility: "private"
    commands:
      - run:
          - apply
          - -f
          - "{{ .workdir }}/portal.yaml"
          - -f
          - "{{ .workdir }}/apis.yaml"
          - --auto-approve

        assertions:
          - select: >-
              plan.changes[?resource_type=='api_publication' && 
                            resource_ref=='sms-api-to-getting-started'] | [0]
            expect:
              fields:
                action: "UPDATE"
          - select: summary
            expect:
              fields:
                applied: 1
                failed: 0
